(function(a){a.fn.JPhotoEditor=function(b){function j(a){return!isNaN(parseFloat(a))&&isFinite(a)}var c=a(this);var d;var e=c.wrap("<div class='editor-container'>").parent();var f=function(){return e.find(".editable")};var g={resize:a("<input id='resize' type='button' name='resize' value='resize'/>"),brightness:a("<input id='brightness-contrast' type='button' name='brightness-contrast' value='brightness/contrast'/>"),crop:a("<input id='crop' type='button' name='crop' value='crop'/>"),rotate_cw:a("<input id='rotate-cw' type='button' name='rotate-cw' value='clockwise'/>"),rotate_ccw:a("<input id='rotate-ccw' type='button' name='rotate-ccw' value='counterclockwise'/>"),save:a("<input id='save-image' type='button' name='save-image' value='save'/>")};var h={brightness:function(){return["<div class='brightness-contrast-control'>","<div id='preview'></div>","<div class='controllers'>","<span class='title'>brightness</span>","<div class='control brightness'></div>","<span class='title'>contrast</span>","<div class='control contrast'></div>","</div>","</div>"].join("")},resize:function(){return["<div class='resize-control'>","<div class='controllers'>","<div class='width-show'>","<span class='title'>width: </span>","<span class='width'></span>","<span>px</span>","</div>","<div class='height-show'>","<span class='title'>height: </span>","<span class='height'></span>","<span>px</span>","</div>","<span class='title'>width: </span>","<input id='width' type='text' size='4' name='width' />","<span class='title'>height: </span>","<input id='height' type='text' size='4' name='height' />","<div class='suggestion'>","</div>","</div>","</div>"].join("")}};var i={previewSize:200,editableClass:".editable"};return this.each(function(){function z(){f().pixastic("brightness")}function y(){g.rotate_ccw.click(function(){t(90)});g.rotate_cw.click(function(){t(-90)});g.crop.click(function(){u()});g.brightness.click(function(){r()});g.resize.click(function(){s()});g.save.click(function(){x()})}function x(){var a=f()[0].toDataURL("image/jpeg");var b=a;var e=i.save_image_url||f().data("save-image-url");var g=i.save_thumb_url||f().data("save-thumb-url");var h=d.getSelection();if(!h.width=="0"){b=c().pixastic("crop",v(h))[0].toDataURL("image/jpeg")}w(e,a);w(g,b)}function w(b,c){window.prompt("Posting to: "+b,c);g.save.attr("disabled","disabled");a.ajax(b,{mg:f,complete:function(a,b){g.save.removeAttr("disabled");if(i.after_save){i.after_save(a,b)}}})}function v(a){return{rect:{left:a.x1,top:a.y1,width:a.width,height:a.height}}}function u(){var a=d.getSelection();if(a.width=="0"){alert("select a rectangular region before cropping.");return false}n("crop",v(a))}function t(a){return n("rotate",{angle:a})}function s(){a(h.resize()).dialog({resizable:false,modal:true,title:"resize",width:190,open:function(b,c){a(this).find(".width-show .width").html(f().width());a(this).find(".height-show .height").html(f().height());a(this).find("input").keyup(function(){var b=a(this);var c=0;var d="";if(!j(b.val()))return false;if(j(b.parent().find("#width").val())&&j(b.parent().find("#height").val()))return false;if(b.attr("id")=="width"){d="height";c=o(f().width(),b.val(),f().height())}else{d="width";c=o(f().height(),b.val(),f().width())}a(this).parent().find(".suggestion").html("suggested "+d+": "+parseInt(c))})},buttons:{Save:function(){var b=a(this).find("input#width").val();var c=a(this).find("input#height").val();if(!j(b)||!j(c)){return false}n("resize",{width:b,height:c});a(this).dialog("close")},Cancel:function(){a(this).dialog("close")}}})}function r(){a(h.brightness()).dialog({resizable:false,modal:true,title:"brightness/contrast",open:function(b,c){a(this).find("#preview").append(k());a(this).find(".control.brightness").slider({min:-150,animate:true,max:150,change:q});a(this).find(".control.contrast").slider({animate:true,min:-1,step:.1,max:1,change:q})},buttons:{Save:function(){var b=a(this).parent().find(".control.contrast").slider("value");var c=a(this).parent().find(".control.brightness").slider("value");n("brightness",{brightness:c,contrast:b});a(this).dialog("close")},Cancel:function(){a(this).dialog("close")}}})}function q(b,c){var d=a(this).parent().find(".control.contrast").slider("value");var e=a(this).parent().find(".control.brightness").slider("value");var f=k().pixastic("brightness",{brightness:e,contrast:d});a(this).parent().parent().find("#preview").empty().append(f)}function p(){var a={};if(f().width()>f().height()){a.width=i.previewSize;a.height=o(f().width(),i.previewSize,f().height())}else{a.height=i.previewSize;a.width=o(f().height(),i.previewSize,f().width())}return a}function o(a,b,c){return c*b/a}function n(a,b){f().pixastic(a,b);m()}function m(){if(d){d.cancelSelection()}d=f().imgAreaSelect({instance:true,handles:true});a(document).keydown(function(a){if(a.keyCode==16){d.setOptions({instance:true,handles:true,aspectRatio:"1:1"});d.update()}});a(document).keyup(function(a){if(a.keyCode==16){d.setOptions({instance:true,handles:true,aspectRatio:false});d.update()}})}function l(){var b=a("<div class='options' />");b.append(g.rotate_ccw);b.append(g.rotate_cw);b.append(g.resize);b.append(g.crop);b.append(g.brightness);b.append(g.save);b.appendTo(e)}function k(){return c().pixastic("resize",p())}function c(){var a=f().clone();var b=f()[0].getContext("2d");var c=b.getImageData(0,0,f().width(),f().height());var d=a[0].getContext("2d");d.putImageData(c,0,0);return a}if(b){a.extend(i,b)}z();m();l();y()})}})(jQuery)